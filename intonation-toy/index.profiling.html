<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Intonation Toy</title>
    <link data-trunk rel="copy-file" href="static/style.css" />
    <link rel="stylesheet" href="style.css" />
    <link data-trunk rel="copy-file" href="static/audio-processor.js" />
    <link data-trunk rel="rust" data-wasm-opt="0" />
    <link data-trunk rel="copy-dir" href="static/icons/" data-trunk-copy-dest="icons/"/>
    
    <!-- Minimal inline CSS for preloader overlay -->
    <style>
      #preloader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #1a1a1a;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
    
    <!-- Inline JavaScript for preloader removal -->
    <script>
      // Global function that WASM can call to remove the preloader
      window.removePreloader = function() {
        const preloader = document.getElementById('preloader-overlay');
        if (preloader) {
          // Add fade-out class for smooth transition
          preloader.classList.add('preloader-fade-out');
          
          // Set up transitionend listener
          let removed = false;
          const removeElement = function() {
            if (!removed && preloader && preloader.parentNode) {
              removed = true;
              preloader.parentNode.removeChild(preloader);
            }
          };
          
          // Remove on transitionend
          preloader.addEventListener('transitionend', removeElement);
          
          // Fallback: Remove after timeout if transitionend doesn't fire
          setTimeout(removeElement, 350); // Slightly longer than CSS animation
        }
      };
      
      // Remove preloader on any error
      window.addEventListener('error', () => window.removePreloader());
      window.addEventListener('unhandledrejection', () => window.removePreloader());
    </script>
  </head>
  <body class="app-body">
    <!-- Preloader Overlay (visible by default) -->
    <div id="preloader-overlay" class="preloader-overlay">
      <div class="preloader-content">
        <h1 class="preloader-title">Intonation Toy</h1>
        <div class="preloader-spinner"></div>
        <p class="preloader-text">Loading...</p>
      </div>
    </div>
    <div id="sidebar" class="app-sidebar">
      <h1 class="sidebar-header">Intonation Toy</h1>
      <div id="main-scene-ui-container" class="ui-container">
        <!-- Root Note Section -->
        <div class="section-group">
          <div class="subsection-header">Root Note</div>
          <div class="control-row">
            <button id="root-note-minus" class="small-button">-</button>
            <span id="root-note-display" class="root-note-display">A3</span>
            <button id="root-note-plus" class="small-button">+</button>
          </div>
          <div class="tuning-fork-controls">
            <div alt="Volume" class="volume-icon"></div>
            <input id="tuning-fork-volume" type="range" min="0" max="100" value="0" />
            <span id="tuning-fork-volume-display" class="volume-display">-âˆž dB</span>
          </div>
          <div id="root-note-help" class="help-text">Match the root note with your voice or instrument to explore intonation. Leave the volume at zero for visual-only tuning mode.</div>
        </div>

        <!-- Tuning System Section -->
        <div class="section-group">
          <div class="subsection-header">Tuning System</div>
          <div class="control-row">
            <select id="tuning-system-select" class="control-select">
              <option value="equal">Equal Temperament</option>
              <option value="just">Just Intonation</option>
            </select>
          </div>
          <div id="tuning-system-help" class="help-text">Choose how notes are tuned: Equal Temperament divides the octave evenly, Just Intonation uses pure whole-number ratios.</div>
        </div>

        <!-- Scale Section -->
        <div class="section-group">
          <div class="subsection-header">Scale</div>
          <div class="control-row">
            <select id="scale-select" class="control-select">
              <option value="chromatic" selected="true">Chromatic</option>
              <option value="major">Major</option>
              <option value="minor">Minor</option>
              <option value="harmonic_minor">Harmonic Minor</option>
              <option value="melodic_minor">Melodic Minor</option>
              <option value="major_pentatonic">Major Pentatonic</option>
              <option value="minor_pentatonic">Minor Pentatonic</option>
              <option value="blues">Blues</option>
              <option value="dorian">Dorian</option>
              <option value="phrygian">Phrygian</option>
              <option value="lydian">Lydian</option>
              <option value="mixolydian">Mixolydian</option>
              <option value="locrian">Locrian</option>
              <option value="whole_tone">Whole Tone</option>
              <option value="augmented">Augmented</option>
              <option value="diminished_half_whole">Diminished (Half-Whole)</option>
              <option value="diminished_whole_half">Diminished (Whole-Half)</option>
              <option value="hungarian_minor">Hungarian Minor</option>
              <option value="neapolitan_minor">Neapolitan Minor</option>
              <option value="neapolitan_major">Neapolitan Major</option>
              <option value="enigmatic">Enigmatic</option>
              <option value="persian">Persian</option>
              <option value="double_harmonic_major">Double Harmonic Major</option>
              <option value="altered">Altered</option>
              <option value="bebop_major">Bebop Major</option>
              <option value="bebop_dominant">Bebop Dominant</option>
            </select>
          </div>
          <div id="scale-help" class="help-text">Choose a musical scale to define which notes are displayed.</div>
        </div>
      </div>

      <!-- About Section -->
      <div class="ui-container about-container">
        <div class="about-section">
          <div class="about-header">About</div>
          <div class="about-content">
            <p class="about-text"><strong>Intonation Toy</strong> is a real-time pitch analysis and visualization tool. Explore musical intonation by analyzing audio input and see how your pitch relates to different tuning systems. Headphones are recommended to prevent your microphone from picking up the root note signal.</p>
          </div>
        </div>
      </div>
    </div>
    <main id="canvas-container" class="app-canvas-container">
      <div id="scene-wrapper">
        <canvas id="three-d-canvas"></canvas>
      </div>
    </main>

    <!-- Error Message Overlay -->
    <div id="error-message-overlay" class="error-overlay error-overlay-hidden">
      <div class="error-panel">
        <h2 id="error-title" class="error-title"></h2>
        <p id="error-details" class="error-details"></p>
      </div>
    </div>

    <!-- First Click Permission Overlay -->
    <div class="first-click-overlay first-click-overlay-hidden">
      <div id="permission-panel" class="first-click-panel">
        <h2 class="first-click-title">Intonation Toy</h2>
        <div class="first-click-description">Click anywhere to start<br><small class="permission-note">(Microphone permission will be requested)</small></div>
      </div>
    </div>
    
    <!-- Trunk will inject the JS/WASM for you -->
  </body>
</html>