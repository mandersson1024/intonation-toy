# Story 3.2: InputManager Implementation

## Metadata
- **Epic**: 3 - Visual Presentation System
- **Story Number**: 3.2
- **Status**: Draft
- **Complexity**: Medium
- **Prerequisites**: Story 3.1 (three-d 2D Graphics Pipeline Setup)
- **Estimated Effort**: 6-8 hours

## Story
As a developer,
I want an InputManager system that handles mouse/touch interactions with GPU-rendered elements,
so that I can enable interactive elements in the 2D graphics pipeline including click logging and microphone permission requests.

## Acceptance Criteria (ACs)

1. **AC1**: Create InputManager component that integrates with the three-d graphics pipeline
2. **AC2**: Implement mouse/touch event handling for GPU-rendered elements (specifically green square in test_scene)
3. **AC3**: Add console logging when clicking the green square in test_scene
4. **AC4**: Implement microphone permission request functionality triggered by green square click
5. **AC5**: Integrate InputManager with the event dispatcher system for event-driven interactions
6. **AC6**: Ensure input handling works seamlessly with 2D graphics rendering pipeline

## Dev Technical Guidance

### Previous Story Insights
Building on Story 3.1 (three-d 2D Graphics Pipeline Setup), which established the 2D graphics rendering foundation with test_scene containing a green square. The existing graphics pipeline provides the rendering context and coordinate system needed for input interaction detection.

### Data Models
Based on the event-driven architecture requirement, implement these input-related data structures:
```rust
pub struct InputEvent {
    pub event_type: InputEventType,
    pub position: (f32, f32),
    pub timestamp: f64,
    pub target_element: Option<String>,
}

pub enum InputEventType {
    MouseClick,
    MouseMove,
    TouchStart,
    TouchEnd,
    TouchMove,
}

pub struct InputManager {
    pub canvas: web_sys::HtmlCanvasElement,
    pub event_dispatcher: Arc<EventDispatcher>,
    pub coordinate_transformer: CoordinateTransformer,
    pub hit_test_registry: Vec<HitTestElement>,
}
```
[Source: docs/architecture/tech-stack.md#event-driven-architecture]

### Component Specifications
The InputManager should integrate with existing components:
- **GraphicsRenderer**: Access to canvas element and coordinate system
- **EventDispatcher**: For publishing input events to other modules
- **test_scene**: Target for initial click detection implementation
- **AudioManager**: For microphone permission requests
[Source: docs/architecture/source-tree.md#module-dependency-graph]

### File Locations
Based on existing project structure:
- **InputManager**: `/pitch-toy/input/mod.rs` (new module)
- **Input Events**: `/pitch-toy/events/input_events.rs` (extend existing events)
- **Coordinate Transform**: `/pitch-toy/input/coordinate_transform.rs`
- **Hit Testing**: `/pitch-toy/input/hit_test.rs`
- **Integration**: `/pitch-toy/graphics/graphics_renderer.rs` (modify existing)
[Source: docs/architecture/source-tree.md#planned-future-structure]

### API Specifications
Following the event-driven architecture pattern:
- **Input → Event System**: Publish InputEvent types through global dispatcher
- **Graphics → Input**: Provide coordinate transformation and hit test areas
- **Audio → Input**: Subscribe to microphone permission request events
[Source: docs/architecture/tech-stack.md#event-driven-architecture]

### Testing Requirements
Input system testing should include:
- **Unit tests**: Coordinate transformation, hit testing logic, event publishing
- **Integration tests**: Canvas event handling, event dispatcher integration
- **Manual tests**: Click detection on green square, microphone permission flow
- **Cross-browser tests**: Touch event handling on mobile devices
[Source: docs/architecture/coding-standards.md#testing-standards]

### Technical Constraints
Critical constraints from architecture:
- **Performance**: Input event processing should not affect 60fps rendering
- **2D Graphics Only**: All interaction must be with 2D GPU-rendered elements
- **Event-Driven**: All communication through event dispatcher system
- **Browser Compatibility**: Support mouse and touch events across target browsers
- **WebAssembly**: All input processing within WASM boundary
[Source: docs/architecture/tech-stack.md#browser-compatibility-matrix]

### Dependencies Requirements
Input system dependencies:
```toml
[dependencies]
web-sys = { version = "0.3", features = [
    "MouseEvent",
    "TouchEvent",
    "EventTarget",
    "HtmlCanvasElement",
    "CanvasRenderingContext2d"
]}
js-sys = "0.3"
wasm-bindgen = "0.2"
```
[Source: docs/architecture/tech-stack.md#development-tools]

### Integration Points
Key integration requirements:
- **Canvas Events**: Attach event listeners to existing graphics canvas
- **Coordinate System**: Transform screen coordinates to graphics space using existing camera
- **Event Dispatcher**: Publish events through existing global dispatcher
- **Audio Integration**: Trigger microphone permission using existing audio module
[Source: docs/architecture/source-tree.md#module-dependency-graph]

## Tasks / Subtasks

### Task 1: InputManager Module Structure (AC: 1, 5)
- [x] Create input module in `/pitch-toy/input/`
- [x] Define InputManager struct with event dispatcher integration
- [x] Create input event types in `/pitch-toy/events/input_events.rs`
- [x] Integrate with existing event system in events/mod.rs
- [x] Add InputManager to graphics renderer initialization

### Task 2: Canvas Event Handling (AC: 2)
- [x] Set up mouse event listeners on graphics canvas
- [x] Implement touch event handling for mobile support
- [x] Create coordinate transformation from screen to graphics space
- [x] Add event prevention to avoid browser default behaviors
- [x] Implement event throttling for performance optimization

### Task 3: Hit Testing System (AC: 2, 3)
- [x] Create HitTestElement registry for clickable areas
- [x] Implement hit testing logic for green square in test_scene
- [x] Add coordinate-based collision detection
- [x] Register green square as interactive element
- [x] Implement click detection and logging to web console

### Task 4: Microphone Permission Integration (AC: 4)
- [ ] Create microphone permission request event type
- [ ] Implement permission request on green square click
- [ ] Handle permission grant/deny responses
- [ ] Integrate with existing audio processing pipeline
- [ ] Add user feedback for permission states

### Task 5: Event Dispatcher Integration (AC: 5)
- [ ] Publish input events through global dispatcher
- [ ] Create event subscriptions for input handling
- [ ] Implement event priority and ordering
- [ ] Add event cleanup and memory management
- [ ] Test event propagation through system

### Task 6: Performance and Validation (AC: 6)
- [ ] Optimize input event processing for 60fps target
- [ ] Add performance monitoring for input latency
- [ ] Implement input event debugging tools
- [ ] Validate cross-browser compatibility
- [ ] Test mobile touch interaction support

### Task 7: Testing and Documentation (AC: All)
- [ ] Create unit tests for coordinate transformation
- [ ] Add integration tests for event handling
- [ ] Implement manual test procedures
- [ ] Add input system documentation
- [ ] Create debugging console commands

## Project Structure Notes
The InputManager represents a new module that bridges user interaction with the GPU-rendered 2D graphics system. It maintains the event-driven architecture while providing the foundation for interactive elements in the 2D graphics pipeline.

## Deviation Analysis
No significant deviations expected. The story aligns with the event-driven architecture requirement and extends the existing 2D graphics pipeline with user interaction capabilities. The integration with the existing event dispatcher and graphics system follows established patterns.

## Definition of Done
- [ ] All acceptance criteria verified and tested
- [ ] InputManager integrates with three-d graphics pipeline
- [ ] Mouse and touch events handled correctly on graphics canvas
- [ ] Green square click detection logs to web console
- [ ] Microphone permission request triggered by click
- [ ] Event dispatcher integration working correctly
- [ ] Performance monitoring shows no impact on 60fps rendering
- [ ] Cross-browser compatibility verified
- [ ] Unit and integration tests pass
- [ ] Code follows project coding standards
- [ ] Documentation updated with InputManager usage

## Dev Agent Record

### Agent Model Used: Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

Task 1 completed successfully. InputManager module structure established with event dispatcher integration. All components properly integrate with existing graphics and events systems. Console logging implemented for debugging click detection. Green square registered as hit test element with proper coordinate mapping from test_scene.

Task 2 completed successfully. Canvas event handling implemented with full mouse and touch support. Added mouse click, mouse move, touch start, touch end, and touch move event handlers. Implemented coordinate transformation from screen to graphics space. Added event prevention to avoid browser default behaviors. Implemented event throttling (16ms/60fps) for performance optimization on mouse move and touch move events. All event handlers properly integrated with existing coordinate transformation and hit testing systems.

Task 3 completed successfully. Hit testing system fully operational with HitTestElement registry and coordinate-based collision detection. Green square registered as interactive element with proper bounds (0,0,0.6,0.6). Fixed InputManager persistence issue by storing globally using thread_local storage to prevent event listener cleanup. Click detection working with console logging for debugging. All 20 input module tests pass, confirming robust hit testing implementation.

### File List

**Created:**
- `/pitch-toy/input/mod.rs` - Input module exports and documentation
- `/pitch-toy/input/input_manager.rs` - Main InputManager implementation with event handling
- `/pitch-toy/input/coordinate_transform.rs` - Screen to graphics coordinate transformation
- `/pitch-toy/input/hit_test.rs` - Hit testing system for clickable elements
- `/pitch-toy/events/input_events.rs` - Input event types and implementations

**Modified:**
- `/pitch-toy/lib.rs` - Added input module and InputManager initialization
- `/pitch-toy/events/mod.rs` - Added input events export
- `/pitch-toy/Cargo.toml` - Added web-sys features for input handling (MouseEvent, TouchEvent, Touch, TouchList, DomRect)

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |

## QA Results

[[LLM: QA Agent Results]]