# Story 2.4: Volume Level Detection

## Metadata
- **Epic**: 2 - Audio Processing Core
- **Story Number**: 2.4
- **Status**: Ready for Development
- **Complexity**: Medium
- **Prerequisites**: Stories 2.1, 2.2, 2.3 (AudioWorklet, Buffer Management, Event Dispatcher)
- **Estimated Effort**: 6-8 hours

## Story
As a user,
I want to see my audio input volume levels,
so that I can monitor my input and ensure proper signal levels for pitch detection.

## Acceptance Criteria (ACs)

1. **AC1**: Volume level calculation from audio input stream
2. **AC2**: Peak level detection with appropriate time constants
3. **AC3**: Volume events published with timestamp information
4. **AC4**: Configurable sensitivity settings for different input sources
5. **AC5**: Visual indication when input levels are too low or too high
6. **AC6**: Integration with pitch detection for confidence weighting

## Dev Technical Guidance

### Previous Story Insights
Stories 2.1-2.3 have established the audio processing pipeline with AudioWorklet, circular buffers, and event dispatching. Volume detection builds on this foundation by adding RMS/peak analysis to the existing buffer processing workflow.

### Data Models
Volume detection requires these data structures:
- `VolumeDetector` struct for processing configuration and state
- `VolumeLevel` enum for classification (Silent, Low, Optimal, High, Clipping)
- `VolumeAnalysis` struct for calculation results
- Extension to `AudioEvent` enum for volume events
[Source: docs/tech-spec.md#audio-processing-module]

### API Specifications
Volume detection integrates with existing audio processing APIs:
- **AudioWorklet integration**: Extend existing worklet for volume analysis
- **Event Dispatcher**: Publish VolumeChanged and VolumeWarning events
- **Console Commands**: Add volume configuration and monitoring commands
[Source: docs/tech-spec.md#event-driven-architecture]

### Component Specifications
Volume detection components:
- **VolumeDetector**: Core volume analysis with RMS and peak detection
- **Volume Event Types**: VolumeChanged and VolumeWarning event structures
- **Console Integration**: volume_status, volume_config, volume_test commands
- **Configuration System**: Sensitivity settings for different input sources
[Source: docs/tech-spec.md#audio-processing-module]

### File Locations
Based on existing project structure:
- **Core Implementation**: `/src/audio/volume_detector.rs` (NEW)
- **Module Export**: `/src/audio/mod.rs` (UPDATED)
- **AudioWorklet Integration**: `/src/audio/worklet.rs` (UPDATED)
- **Event Definitions**: `/src/events/audio_events.rs` (UPDATED)
- **Console Commands**: `/src/console/audio_commands.rs` (UPDATED)
[Source: existing project structure and docs/tech-spec.md#implementation-phases]

### Testing Requirements
Volume detection testing strategy:
- **Unit Tests**: RMS calculation accuracy, peak detection behavior
- **Integration Tests**: Event publishing, console command functionality
- **Performance Tests**: Latency measurement, zero-allocation validation
- **Signal Tests**: Use existing TestSignalGenerator for deterministic testing
[Source: docs/tech-spec.md#testing-strategy]

### Technical Constraints
- **Latency**: Volume calculation ≤1ms per block, ≤2ms total contribution
- **Memory**: Zero heap allocations during steady-state processing
- **CPU Usage**: ≤0.5% for volume detection alone
- **Sample Rates**: 44.1kHz and 48kHz standard support
- **Buffer Sizes**: 128-2048 samples support
[Source: docs/tech-spec.md#performance-requirements]

### Dependencies Requirements
Volume detection builds on these existing components:
- **AudioWorklet**: Real-time audio processing pipeline
- **BufferAnalyzer**: Sequential block processing for audio analysis
- **Event Dispatcher**: Typed event publishing system
- **Console System**: Interactive command processing
[Source: docs/tech-spec.md#core-dependencies]

### Performance Requirements
Volume detection performance targets:
- **RMS Calculation**: Numerically stable, stack-allocated computation
- **Peak Detection**: Exponential decay with fast (100ms) and slow (1000ms) time constants
- **Event Publishing**: <1ms latency after calculation completion
- **Configuration Changes**: <10ms effect latency without audio restart
[Source: docs/tech-spec.md#performance-requirements]

## Tasks / Subtasks

### Task 1: Implement Core VolumeDetector (AC: 1, 2)
- [ ] Create `/src/audio/volume_detector.rs` with VolumeDetector struct
- [ ] Implement RMS calculation with zero-allocation design
- [ ] Add peak detection with exponential decay time constants
- [ ] Create VolumeLevel enum for classification (Silent, Low, Optimal, High, Clipping)
- [ ] Implement volume level classification logic with dB thresholds
- [ ] Add confidence weight calculation based on volume levels

### Task 2: Integrate with AudioWorklet Pipeline (AC: 1, 3)
- [ ] Update `/src/audio/worklet.rs` to include volume analysis
- [ ] Integrate VolumeDetector with existing BufferAnalyzer workflow
- [ ] Add volume analysis to real-time audio processing loop
- [ ] Ensure zero-allocation processing during steady-state operation
- [ ] Add error handling for edge cases (NaN, infinity values)

### Task 3: Implement Event System Integration (AC: 3, 5)
- [ ] Update `/src/events/audio_events.rs` with volume event types:
  - VolumeChanged event with RMS, peak levels, classification, timestamp
  - VolumeWarning event for problematic volume levels
- [ ] Add volume events to AudioEvent enum
- [ ] Implement event publishing via Event Dispatcher
- [ ] Add warning state tracking for sustained problematic levels

### Task 4: Add Configuration System (AC: 4)
- [ ] Implement configurable sensitivity parameters:
  - input_gain_db: Linear gain adjustment (-60dB to +60dB)
  - noise_floor_db: Noise floor threshold (-80dB to -20dB)
  - peak_decay_fast_ms: Fast decay time constant (10ms to 500ms)
  - peak_decay_slow_ms: Slow decay time constant (100ms to 5000ms)
- [ ] Add parameter validation and error handling
- [ ] Implement immediate configuration changes without audio restart

### Task 5: Console Command Integration (AC: 4, 5)
- [ ] Add volume monitoring commands to console system:
  - `volume_status`: Display current volume levels and configuration
  - `volume_config`: Configure sensitivity parameters
  - `volume_test`: Generate test signals for volume detection validation
- [ ] Implement command help documentation
- [ ] Add real-time volume level display in console

### Task 6: Pitch Detection Integration (AC: 6)
- [ ] Implement confidence weighting based on volume levels
- [ ] Integrate volume-based confidence with pitch detection algorithms
- [ ] Add volume context to pitch detection event publishing
- [ ] Ensure confidence weights properly combine with spectral confidence

### Task 7: Unit Testing Implementation (AC: All)
- [ ] Create comprehensive unit tests for volume calculations
- [ ] Add tests for peak detection and decay behavior
- [ ] Implement volume classification testing
- [ ] Add confidence weighting tests
- [ ] Create zero-allocation validation tests
- [ ] Add performance benchmarking tests

### Task 8: Integration Testing and Validation (AC: All)
- [ ] Test volume detection with existing audio processing pipeline
- [ ] Validate event publishing and console command functionality
- [ ] Perform end-to-end testing with TestSignalGenerator
- [ ] Verify performance targets (latency, CPU usage, memory)
- [ ] Test configuration changes and parameter validation
- [ ] Validate pitch detection confidence weighting integration

## Project Structure Notes
The volume detection implementation leverages the existing audio processing architecture established in Stories 2.1-2.3. The modular design allows volume detection to integrate seamlessly with the AudioWorklet pipeline while maintaining the zero-allocation performance requirements.

## Deviation Analysis
No significant deviations between epic requirements and architecture constraints identified. Volume detection aligns well with the event-driven architecture and performance targets specified in the technical specification.

## Definition of Done
- [ ] All acceptance criteria verified and tested
- [ ] VolumeDetector implemented with RMS and peak detection
- [ ] Volume events published via Event Dispatcher
- [ ] Console commands functional for volume monitoring and configuration
- [ ] Pitch detection confidence weighting integrated
- [ ] Performance targets met (≤1ms calculation, ≤2ms total latency)
- [ ] Zero-allocation processing validated
- [ ] Unit and integration tests passing
- [ ] Code follows project coding standards and conventions

## Dev Agent Record

### Implementation Notes
*To be filled during development*

### Challenges and Solutions
*To be filled during development*

### Performance Metrics
*To be filled during development*

### Completion Notes
*To be filled during development*

### File List
*To be filled during development*

### Debug Log References
*To be filled during development*