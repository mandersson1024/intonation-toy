# Story 3.18: Audio Event Publishing Integration

## Status: Draft

## Story

- As a **UI developer**
- I want **real-time audio events** 
- so that I can **update visualizations and user interface based on audio processing state**

## Acceptance Criteria (ACs)

- [ ] Pitch detection events published to event bus
- [ ] Device state change events (connection, disconnection, errors)
- [ ] Audio processing state events (started, stopped, suspended)
- [ ] Performance metric events for monitoring dashboards
- [ ] Error events with context and recovery suggestions
- [ ] Educational events for learning applications
- [ ] Event batching for performance optimization

## Tasks / Subtasks

- [ ] Task 1: Integrate pitch detection events with TypedEventBus (AC: 1)
  - [ ] Update `MultiAlgorithmPitchDetector` to publish `PitchDetectionEvent`
  - [ ] Add confidence and signal info to pitch events
  - [ ] Ensure <1ms event publishing latency for real-time updates
  - [ ] Add buffer reference metadata to events

- [ ] Task 2: Implement device state event publishing (AC: 2)
  - [ ] Update `DeviceManager` to publish device connection/disconnection events
  - [ ] Add microphone permission state change events
  - [ ] Implement device capability change notifications
  - [ ] Add device error events with recovery suggestions

- [ ] Task 3: Add audio processing lifecycle events (AC: 3)
  - [ ] Publish audio engine start/stop/suspend events
  - [ ] Add audio stream state change events
  - [ ] Implement audio context state notifications
  - [ ] Add buffer processing status events

- [ ] Task 4: Integrate performance monitoring events (AC: 4)
  - [ ] Connect `AudioPerformanceMonitor` to event bus
  - [ ] Publish performance threshold violation events
  - [ ] Add performance regression detection events
  - [ ] Implement real-time latency and throughput events

- [ ] Task 5: Implement error event publishing (AC: 5)
  - [ ] Add comprehensive error context to error events
  - [ ] Include recovery suggestions in error events
  - [ ] Implement error severity classification
  - [ ] Add error source tracking (device, processing, network)

- [ ] Task 6: Add educational/learning events (AC: 6)
  - [ ] Publish musical interval detection events
  - [ ] Add pitch accuracy feedback events
  - [ ] Implement learning progress tracking events
  - [ ] Add practice session statistics events

- [ ] Task 7: Implement event batching optimization (AC: 7)
  - [ ] Add non-critical event batching system
  - [ ] Implement configurable batch sizes and intervals
  - [ ] Ensure critical events bypass batching
  - [ ] Add batch processing performance monitoring

## Dev Notes

### Source Tree Context
[Source: docs/architecture/source-tree.md#audio-processing-layer]

- **Audio Module Location**: `src/modules/audio_foundations/` 
- **Event Definitions**: `src/modules/audio_foundations/audio_events.rs` (already exists)
- **Integration Point**: AudioFoundationsModule implements event publishing
- **Event Bus Integration**: Uses TypedEventBus from `src/modules/application_core/`

### Architecture Context
[Source: docs/architecture/tech-stack.md#webassembly]

- **Performance Target**: Event publishing <1ms for critical events
- **WebAssembly Constraints**: Minimize allocations in event publishing hot path
- **JavaScript Interop**: Events must be efficiently serializable for JS consumption
- **Real-time Audio**: Event publishing cannot affect <10ms audio processing latency

### Previous Story Context
[Source: docs/stories/epic-003-audio-foundations-stories.md Story 017]

**Key Integration Points from Previous Stories:**
- Story 013: `AudioFoundationsModule` wrapper provides event bus access via `self.event_bus`
- Story 014: Device events already defined in `audio_events.rs`, need integration
- Story 015: Pitch detection events partially implemented, need completion  
- Story 017: Performance monitoring events defined, need event bus publishing

**Event Publishing Pattern Established:**
```rust
// From Story 013 implementation pattern:
impl AudioFoundationsModule {
    fn publish_critical_event<T: Event>(&self, event: T) {
        self.event_bus.publish_critical(event);
    }
}
```

### Event Bus Integration Requirements
[Source: Epic 001 implementation]

- **Event Bus Interface**: Uses `TypedEventBus` with priority-based publishing
- **Event Priorities**: Critical (<1ms), High (<5ms), Normal (<100ms), Low (best effort)
- **Type Safety**: All events must implement `Event` trait with proper serialization
- **Performance**: Zero-copy event publishing for audio processing events

### Technical Implementation Details

**Event Categories and Priorities:**
1. **Critical Events** (publish_critical): Pitch detection results, audio dropouts
2. **High Priority** (publish_high): Device state changes, error events  
3. **Normal Priority** (publish_normal): Performance metrics, educational events
4. **Low Priority** (publish_low): Batched statistics, debug information

**Event Publishing Interface:**
```rust
// Audio Foundation publishes these event types:
impl AudioFoundationsModule {
    fn publish_pitch_detected(&self, result: PitchResult) {
        let event = PitchDetectionEvent {
            frequency: result.frequency,
            confidence: result.confidence,
            signal_info: SignalInfo::from(result),
            processing_time_ns: result.processing_time_ns,
            timestamp_ns: get_timestamp(),
            source_buffer_ref: self.current_buffer_ref,
        };
        self.event_bus.publish_critical(event);
    }
    
    fn publish_device_state(&self, device_id: &str, state: DeviceState) {
        let event = MicrophoneStateEvent {
            state,
            device_info: self.get_device_info(device_id),
            permissions: self.current_permissions,
            timestamp_ns: get_timestamp(),
        };
        self.event_bus.publish_high(event);
    }
}
```

### Testing

Dev Note: Story Requires the following tests:

- [ ] Rust Unit Tests: (nextToFile: true), coverage requirement: 90%
- [ ] Integration Test (Test Location): location: `src/modules/audio_foundations/event_integration_tests.rs`
- [ ] Manual Test: Audio event dashboard to verify real-time event publishing

Manual Test Steps:

- Dev will create integration test that demonstrates all event types being published correctly to event bus
- Dev will verify event publishing latency meets performance requirements (<1ms critical, <5ms high priority)
- Dev will test event batching system reduces non-critical event load by >50%
- Dev will validate error events include proper context and recovery suggestions

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- | 